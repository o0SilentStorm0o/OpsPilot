name: Model Testing & Validation

on:
  # Trigger on code changes
  push:
    branches: [ main, develop ]
    paths:
      - 'ml/**'
      - '.github/workflows/model-test.yml'
  
  pull_request:
    branches: [ main ]
    paths:
      - 'ml/**'
  
  # Manual trigger
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  HF_MODEL_REPO: 'SilentStorm99/opspilot-phi3-lora-v6'

jobs:
  # Stage 1: Download model from HuggingFace and run tests
  test-model:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-ml-${{ hashFiles('ml/requirements.txt') }}
    
    - name: Install dependencies
      run: |
        pip install -r ml/requirements.txt
        pip install pytest pytest-cov huggingface_hub
    
    - name: Download model from HuggingFace
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        cd ml
        echo "üì¶ Downloading trained model from HuggingFace..."
        python -c "
        from huggingface_hub import snapshot_download
        import os
        
        model_path = snapshot_download(
            repo_id='${{ env.HF_MODEL_REPO }}',
            token=os.getenv('HF_TOKEN'),
            local_dir='./outputs/lora_phi3_v6/final',
            local_dir_use_symlinks=False
        )
        print(f'‚úÖ Model downloaded to: {model_path}')
        "
        
        echo "üìÇ Model contents:"
        ls -lh ./outputs/lora_phi3_v6/final/
    
    - name: Verify model files
      run: |
        cd ml
        echo "üîç Verifying model files..."
        
        if [ ! -f "./outputs/lora_phi3_v6/final/adapter_model.safetensors" ]; then
          echo "‚ùå Error: adapter_model.safetensors not found"
          exit 1
        fi
        
        if [ ! -f "./outputs/lora_phi3_v6/final/adapter_config.json" ]; then
          echo "‚ùå Error: adapter_config.json not found"
          exit 1
        fi
        
        echo "‚úÖ All required model files present"
    
    - name: Validate LoRA configuration
      run: |
        cd ml
        echo "üß™ Running basic model validation..."
        python -c "
        import json
        import os
        
        # Check adapter config is valid JSON
        print('ÔøΩ Validating adapter_config.json...')
        with open('./outputs/lora_phi3_v6/final/adapter_config.json', 'r') as f:
            config = json.load(f)
        
        print(f'  ‚úÖ Base model: {config.get(\"base_model_name_or_path\", \"N/A\")}')
        print(f'  ‚úÖ PEFT type: {config.get(\"peft_type\", \"N/A\")}')
        print(f'  ‚úÖ Task type: {config.get(\"task_type\", \"N/A\")}')
        
        # Check model file size (should be reasonable)
        model_file = './outputs/lora_phi3_v6/final/adapter_model.safetensors'
        file_size = os.path.getsize(model_file) / (1024 * 1024)  # MB
        print(f'  ‚úÖ Model size: {file_size:.2f} MB')
        
        if file_size < 1 or file_size > 100:
            print(f'  ‚ö†Ô∏è  Warning: Unexpected model size')
        
        print('‚úÖ Model validation passed!')
        "
    
    - name: Quick smoke test (optional)
      continue-on-error: true
      run: |
        cd ml
        echo "üî• Running smoke test (optional, can fail)..."
        echo "‚ö†Ô∏è  Full inference test disabled to save CI time"
        echo "‚úÖ Smoke test skipped"
    
    - name: Run unit tests
      continue-on-error: true
      run: |
        cd ml
        echo "üß™ Running unit tests..."
        echo "‚ö†Ô∏è  No unit tests configured yet - skipping"
        # pytest tests/ -v --cov=. --cov-report=term-missing
    
    - name: Test summary
      if: always()
      run: |
        echo "## üìä Model Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Model Repository:** ${{ env.HF_MODEL_REPO }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Base Model:** microsoft/Phi-3-mini-4k-instruct" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
